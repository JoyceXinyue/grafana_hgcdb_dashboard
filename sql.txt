WITH temp_table AS 
    (SELECT 
        DISTINCT ON (module_no) * 
        FROM module_qc_summary 
        ORDER BY module_no, mod_qc_no DESC)

        SELECT COUNT(*) AS count
        FROM temp_table
        JOIN module_info ON temp_table.module_no = module_info.module_no
        WHERE 
            ('All' = ANY(ARRAY[${final_grade}]) OR temp_table.final_grade::text = ANY(ARRAY[${final_grade}]))
            AND $__timeFilter(module_info.assembled) 